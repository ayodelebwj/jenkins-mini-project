pipeline {
    
    agent any

    environment {
    AWS_SECRET_ACCESS_KEY = credentials ('aws-secret-access-key')
    AWS_ACCESS_KEY_ID = credentials ('aws-access-key-id')
    AWS_DEFAULT_REGION = 'us-east-1'
    SOURCE_AMI = credentials ('source-ami')
    }

    stages {
        stage('Checkout') {

            steps {
                git branch: 'main'
                url: 'https://github.com/ayodelebwj/jenkins-mini-project.git'
            }
        }

        stage('Build AMI') {
            steps {
                dir ('packer') {
                    sh 'packer init'
                    sh 'packer fmt .'
                    sh 'packer validate .'
                    sh 'packer build python-ami.pkr.hcl'
                    sh 'packer build java-ami.pkr.hcl'
                    sh 'packer build web-ami.pkr.hcl'
                }
            }
        }

        stage('Build Python Machine') {
            steps {
                dir ('terraform/python/') {
                    sh 'terraform init'
                    sh 'terraform fmt .'
                    sh 'terraform validate .'
                    sh 'terraform plan'
                    sh 'terraform apply --auto-approve'
                }
            }
        }

        stage('Build Java Machine') {
            steps {
                dir ('terraform/java/') {
                    sh 'terraform init'
                    sh 'terraform fmt .'
                    sh 'terraform validate .'
                    sh 'terraform plan'
                    sh 'terraform apply --auto-approve'
                }
            }
        }

        stage('Build Web Nginx Machine') {
            steps {
                dir ('terraform/web/') {
                    sh 'terraform init'
                    sh 'terraform fmt .'
                    sh 'terraform validate .'
                    sh 'terraform plan'
                    sh 'terraform apply --auto-approve'
                }
            }
        }
    }

    post {
        success {
            echo 'Infrastructure completed successfully'
        }

         failure {
            echo 'Infrastructure setup failed'
        }
    }
}